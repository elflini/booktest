<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Sankey Diagram | R Graph</title>
  <meta name="description" content="This is R code for graph, especially using ggplot2" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Sankey Diagram | R Graph" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is R code for graph, especially using ggplot2" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Sankey Diagram | R Graph" />
  
  <meta name="twitter:description" content="This is R code for graph, especially using ggplot2" />
  

<meta name="author" content="Jin Hyun Nam" />


<meta name="date" content="2021-07-09" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="boxplot.html"/>

<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.3/htmlwidgets.js"></script>
<script src="libs/d3-4.5.0/d3.min.js"></script>
<script src="libs/sankey-1/sankey.js"></script>
<script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">R graph</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>머리말</a></li>
<li class="chapter" data-level="1" data-path="histogram.html"><a href="histogram.html"><i class="fa fa-check"></i><b>1</b> Histogram</a>
<ul>
<li class="chapter" data-level="1.1" data-path="histogram.html"><a href="histogram.html#toy-data-generation"><i class="fa fa-check"></i><b>1.1</b> Toy data generation</a></li>
<li class="chapter" data-level="1.2" data-path="histogram.html"><a href="histogram.html#basic-histogram-with-ggplot2"><i class="fa fa-check"></i><b>1.2</b> Basic histogram with ggplot2</a></li>
<li class="chapter" data-level="1.3" data-path="histogram.html"><a href="histogram.html#change-the-color"><i class="fa fa-check"></i><b>1.3</b> Change the color</a></li>
<li class="chapter" data-level="1.4" data-path="histogram.html"><a href="histogram.html#change-the-width-of-bins"><i class="fa fa-check"></i><b>1.4</b> Change the width of bins</a></li>
<li class="chapter" data-level="1.5" data-path="histogram.html"><a href="histogram.html#add-mean-line"><i class="fa fa-check"></i><b>1.5</b> Add mean line</a></li>
<li class="chapter" data-level="1.6" data-path="histogram.html"><a href="histogram.html#histogram-with-density-plot"><i class="fa fa-check"></i><b>1.6</b> Histogram with density plot</a></li>
<li class="chapter" data-level="1.7" data-path="histogram.html"><a href="histogram.html#histogram-with-density-plot-and-mean-line"><i class="fa fa-check"></i><b>1.7</b> Histogram with density plot and mean line</a></li>
<li class="chapter" data-level="1.8" data-path="histogram.html"><a href="histogram.html#histogram-by-subgroup-with-stack-option"><i class="fa fa-check"></i><b>1.8</b> Histogram by subgroup with ‘stack’ option</a></li>
<li class="chapter" data-level="1.9" data-path="histogram.html"><a href="histogram.html#histogram-by-subgroup-with-identity-option"><i class="fa fa-check"></i><b>1.9</b> Histogram by subgroup with ‘identity’ option</a></li>
<li class="chapter" data-level="1.10" data-path="histogram.html"><a href="histogram.html#histogram-by-subgroup-with-dodge-option"><i class="fa fa-check"></i><b>1.10</b> Histogram by subgroup with ‘dodge’ option</a></li>
<li class="chapter" data-level="1.11" data-path="histogram.html"><a href="histogram.html#data-generation-for-means-by-group-with-dplyr-package"><i class="fa fa-check"></i><b>1.11</b> Data generation for means by group with ‘dplyr’ package</a></li>
<li class="chapter" data-level="1.12" data-path="histogram.html"><a href="histogram.html#histogram-by-subgroup-with-density-plot-and-mean-line"><i class="fa fa-check"></i><b>1.12</b> Histogram by subgroup with density plot and mean line</a></li>
<li class="chapter" data-level="1.13" data-path="histogram.html"><a href="histogram.html#data-generation-of-each-variables-instead-of-group"><i class="fa fa-check"></i><b>1.13</b> Data generation of each variables instead of group</a></li>
<li class="chapter" data-level="1.14" data-path="histogram.html"><a href="histogram.html#histogram-with-each-variables"><i class="fa fa-check"></i><b>1.14</b> Histogram with each variables</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="boxplot.html"><a href="boxplot.html"><i class="fa fa-check"></i><b>2</b> Boxplot</a>
<ul>
<li class="chapter" data-level="2.1" data-path="boxplot.html"><a href="boxplot.html#toy-data-generation-1"><i class="fa fa-check"></i><b>2.1</b> Toy data generation</a></li>
<li class="chapter" data-level="2.2" data-path="boxplot.html"><a href="boxplot.html#basic-boxplot-with-ggplot2"><i class="fa fa-check"></i><b>2.2</b> Basic Boxplot with ggplot2</a></li>
<li class="chapter" data-level="2.3" data-path="boxplot.html"><a href="boxplot.html#change-the-color-1"><i class="fa fa-check"></i><b>2.3</b> Change the color</a></li>
<li class="chapter" data-level="2.4" data-path="boxplot.html"><a href="boxplot.html#change-the-color-by-group"><i class="fa fa-check"></i><b>2.4</b> Change the color by group</a></li>
<li class="chapter" data-level="2.5" data-path="boxplot.html"><a href="boxplot.html#geom_boxplot-proposes-several-arguments-to-custom-appearance"><i class="fa fa-check"></i><b>2.5</b> geom_boxplot proposes several arguments to custom appearance</a></li>
<li class="chapter" data-level="2.6" data-path="boxplot.html"><a href="boxplot.html#boxplot-with-group-and-subgroup"><i class="fa fa-check"></i><b>2.6</b> Boxplot with group and subgroup</a></li>
<li class="chapter" data-level="2.7" data-path="boxplot.html"><a href="boxplot.html#boxplot-using-small-multiple-group"><i class="fa fa-check"></i><b>2.7</b> Boxplot using small multiple group</a></li>
<li class="chapter" data-level="2.8" data-path="boxplot.html"><a href="boxplot.html#boxplot-with-different-box-widths"><i class="fa fa-check"></i><b>2.8</b> Boxplot with different box widths</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="sankey-diagram.html"><a href="sankey-diagram.html"><i class="fa fa-check"></i><b>3</b> Sankey Diagram</a>
<ul>
<li class="chapter" data-level="3.1" data-path="sankey-diagram.html"><a href="sankey-diagram.html#from-connection-data-frame"><i class="fa fa-check"></i><b>3.1</b> From connection data frame</a></li>
<li class="chapter" data-level="3.2" data-path="sankey-diagram.html"><a href="sankey-diagram.html#from-incidence-matrix"><i class="fa fa-check"></i><b>3.2</b> From incidence matrix</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">R Graph</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="sankey-diagram" class="section level1" number="3">
<h1><span class="header-section-number">Chapter 3</span> Sankey Diagram</h1>
<p>Sankey diagrams are a type of flow diagram in which the width of the arrows is proportional to the flow rate.</p>
<p>The illustration shows a Sankey diagram that represents all the primary energy that flows into a factory. The widths of the bands are linearly proportional to energy production, utilization and loss. The primary energy inputs enter the left side of the diagram, and are differentiated into gas, electricity and coal/oil.</p>
<p>Sankey diagrams can also visualize the energy accounts, material flow accounts on a regional or national level, and cost breakdowns.</p>
<p>Sankey diagrams emphasize the major transfers or flows within a system. They help locate the most important contributions to a flow. They often show conserved quantities within defined system boundaries.
- Wikipedia -</p>
<ul>
<li>필요 패키지: networkD3</li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="sankey-diagram.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;networkD3&quot;</span>)</span>
<span id="cb1-2"><a href="sankey-diagram.html#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">&quot;tidyverse&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="sankey-diagram.html#cb2-1" aria-hidden="true" tabindex="-1"></a>   <span class="fu">library</span>(networkD3)</span>
<span id="cb2-2"><a href="sankey-diagram.html#cb2-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">library</span>(tidyverse)</span></code></pre></div>
<pre><code>## -- Attaching packages --------------------------------------- tidyverse 1.3.1 --</code></pre>
<pre><code>## v ggplot2 3.3.3     v purrr   0.3.4
## v tibble  3.1.2     v dplyr   1.0.6
## v tidyr   1.1.3     v stringr 1.4.0
## v readr   1.4.0     v forcats 0.5.1</code></pre>
<pre><code>## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()</code></pre>
<p>Sankey Diagram can be built in R using the networkD3 package. This posts displays basic example, focusing on the different input formats that can be used.</p>
<p>A Sankey diagram represents flows, i.e. weigthed connections going from one node to another. Input data can be stored in 2 different formats:</p>
<ul>
<li>connection data frame (3 columns)</li>
<li>incidence matrix (square matrix)</li>
</ul>
<p>This post describes how to build a basic Sankey diagram from these 2 types of input.</p>
<div id="from-connection-data-frame" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> From connection data frame</h2>
<p>A connection data frame lists all the connections one by one in a data frame.</p>
<p>Usually you have a source and a target column. You can add a third column that gives further information for each connection, like the value of the flow.</p>
<p>This is the format you need to use the <em>networkD3</em> library. Let’s build a connection data frame and represent it as a Sankey diagram:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="sankey-diagram.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># A connection data frame is a list of flows with intensity for each flow</span></span>
<span id="cb6-2"><a href="sankey-diagram.html#cb6-2" aria-hidden="true" tabindex="-1"></a>   links <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-3"><a href="sankey-diagram.html#cb6-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">source=</span><span class="fu">c</span>(<span class="st">&quot;group_A&quot;</span>,<span class="st">&quot;group_A&quot;</span>, <span class="st">&quot;group_B&quot;</span>, <span class="st">&quot;group_C&quot;</span>, <span class="st">&quot;group_C&quot;</span>, <span class="st">&quot;group_E&quot;</span>), </span>
<span id="cb6-4"><a href="sankey-diagram.html#cb6-4" aria-hidden="true" tabindex="-1"></a>     <span class="at">target=</span><span class="fu">c</span>(<span class="st">&quot;group_C&quot;</span>,<span class="st">&quot;group_D&quot;</span>, <span class="st">&quot;group_E&quot;</span>, <span class="st">&quot;group_F&quot;</span>, <span class="st">&quot;group_G&quot;</span>, <span class="st">&quot;group_H&quot;</span>), </span>
<span id="cb6-5"><a href="sankey-diagram.html#cb6-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">value=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span>)</span>
<span id="cb6-6"><a href="sankey-diagram.html#cb6-6" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb6-7"><a href="sankey-diagram.html#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="sankey-diagram.html#cb6-8" aria-hidden="true" tabindex="-1"></a>links</span></code></pre></div>
<pre><code>##    source  target value
## 1 group_A group_C     2
## 2 group_A group_D     3
## 3 group_B group_E     2
## 4 group_C group_F     3
## 5 group_C group_G     1
## 6 group_E group_H     3</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="sankey-diagram.html#cb8-1" aria-hidden="true" tabindex="-1"></a>   <span class="co"># From these flows we need to create a node data frame: it lists every entities involved in the flow</span></span>
<span id="cb8-2"><a href="sankey-diagram.html#cb8-2" aria-hidden="true" tabindex="-1"></a>   nodes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb8-3"><a href="sankey-diagram.html#cb8-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">name=</span><span class="fu">c</span>(<span class="fu">as.character</span>(links<span class="sc">$</span>source), </span>
<span id="cb8-4"><a href="sankey-diagram.html#cb8-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">as.character</span>(links<span class="sc">$</span>target)) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb8-5"><a href="sankey-diagram.html#cb8-5" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb8-6"><a href="sankey-diagram.html#cb8-6" aria-hidden="true" tabindex="-1"></a>nodes</span></code></pre></div>
<pre><code>##      name
## 1 group_A
## 2 group_B
## 3 group_C
## 4 group_E
## 5 group_D
## 6 group_F
## 7 group_G
## 8 group_H</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="sankey-diagram.html#cb10-1" aria-hidden="true" tabindex="-1"></a>   <span class="co"># With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.</span></span>
<span id="cb10-2"><a href="sankey-diagram.html#cb10-2" aria-hidden="true" tabindex="-1"></a>   links<span class="sc">$</span>IDsource <span class="ot">&lt;-</span> <span class="fu">match</span>(links<span class="sc">$</span>source, nodes<span class="sc">$</span>name)<span class="sc">-</span><span class="dv">1</span> </span>
<span id="cb10-3"><a href="sankey-diagram.html#cb10-3" aria-hidden="true" tabindex="-1"></a>   links<span class="sc">$</span>IDtarget <span class="ot">&lt;-</span> <span class="fu">match</span>(links<span class="sc">$</span>target, nodes<span class="sc">$</span>name)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb10-4"><a href="sankey-diagram.html#cb10-4" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb10-5"><a href="sankey-diagram.html#cb10-5" aria-hidden="true" tabindex="-1"></a>   links</span></code></pre></div>
<pre><code>##    source  target value IDsource IDtarget
## 1 group_A group_C     2        0        2
## 2 group_A group_D     3        0        4
## 3 group_B group_E     2        1        3
## 4 group_C group_F     3        2        5
## 5 group_C group_G     1        2        6
## 6 group_E group_H     3        3        7</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="sankey-diagram.html#cb12-1" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Make the Network</span></span>
<span id="cb12-2"><a href="sankey-diagram.html#cb12-2" aria-hidden="true" tabindex="-1"></a>   p <span class="ot">&lt;-</span> <span class="fu">sankeyNetwork</span>(<span class="at">Links =</span> links, <span class="at">Nodes =</span> nodes,</span>
<span id="cb12-3"><a href="sankey-diagram.html#cb12-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Source =</span> <span class="st">&quot;IDsource&quot;</span>, <span class="at">Target =</span> <span class="st">&quot;IDtarget&quot;</span>,</span>
<span id="cb12-4"><a href="sankey-diagram.html#cb12-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Value =</span> <span class="st">&quot;value&quot;</span>, <span class="at">NodeID =</span> <span class="st">&quot;name&quot;</span>, </span>
<span id="cb12-5"><a href="sankey-diagram.html#cb12-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sinksRight=</span><span class="cn">FALSE</span>)</span>
<span id="cb12-6"><a href="sankey-diagram.html#cb12-6" aria-hidden="true" tabindex="-1"></a>   p</span></code></pre></div>
<div id="htmlwidget-a1520660930b6a0b7046" style="width:672px;height:480px;" class="sankeyNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-a1520660930b6a0b7046">{"x":{"links":{"source":[0,0,1,2,2,3],"target":[2,4,3,5,6,7],"value":[2,3,2,3,1,3]},"nodes":{"name":["group_A","group_B","group_C","group_E","group_D","group_F","group_G","group_H"],"group":["group_A","group_B","group_C","group_E","group_D","group_F","group_G","group_H"]},"options":{"NodeID":"name","NodeGroup":"name","LinkGroup":null,"colourScale":"d3.scaleOrdinal(d3.schemeCategory20);","fontSize":7,"fontFamily":null,"nodeWidth":15,"nodePadding":10,"units":"","margin":{"top":null,"right":null,"bottom":null,"left":null},"iterations":32,"sinksRight":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="sankey-diagram.html#cb13-1" aria-hidden="true" tabindex="-1"></a>    save the widget</span>
<span id="cb13-2"><a href="sankey-diagram.html#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(htmlwidgets)</span>
<span id="cb13-3"><a href="sankey-diagram.html#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveWidget</span>(p, <span class="at">file=</span><span class="fu">paste0</span>( <span class="fu">getwd</span>(), <span class="st">&quot;/HtmlWidget/sankeyBasic1.html&quot;</span>))</span></code></pre></div>
</div>
<div id="from-incidence-matrix" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> From incidence matrix</h2>
<p>An incidence matrix is square or rectangle.</p>
<p>Row and column names are node names. The item in row x and column y represents the flow between x and y. In the Sankey diagram we represent all flows that are over 0.</p>
<p>Since the networkD3 library expects a connection data frame, we will fist convert the dataset, and then re-use the code from above.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="sankey-diagram.html#cb14-1" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Create an incidence matrix. Usually the flow goes from the row names to the column names.</span></span>
<span id="cb14-2"><a href="sankey-diagram.html#cb14-2" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Remember that our connection are directed since we are working with a flow.</span></span>
<span id="cb14-3"><a href="sankey-diagram.html#cb14-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb14-4"><a href="sankey-diagram.html#cb14-4" aria-hidden="true" tabindex="-1"></a>   data <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">sample</span>( <span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">40</span>), <span class="dv">49</span>, <span class="at">replace=</span>T ), <span class="dv">7</span>, <span class="dv">7</span>)</span>
<span id="cb14-5"><a href="sankey-diagram.html#cb14-5" aria-hidden="true" tabindex="-1"></a>   data[data <span class="sc">&lt;</span> <span class="dv">35</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb14-6"><a href="sankey-diagram.html#cb14-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">colnames</span>(data) <span class="ot">=</span> <span class="fu">rownames</span>(data) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;group_A&quot;</span>, <span class="st">&quot;group_B&quot;</span>, <span class="st">&quot;group_C&quot;</span>, <span class="st">&quot;group_D&quot;</span>, <span class="st">&quot;group_E&quot;</span>, <span class="st">&quot;group_F&quot;</span>, <span class="st">&quot;group_G&quot;</span>)</span>
<span id="cb14-7"><a href="sankey-diagram.html#cb14-7" aria-hidden="true" tabindex="-1"></a>   data</span></code></pre></div>
<pre><code>##         group_A group_B group_C group_D group_E group_F group_G
## group_A       0       0       0       0      37       0       0
## group_B      38       0      36       0       0       0       0
## group_C       0       0      40       0       0      38       0
## group_D       0       0       0       0       0       0       0
## group_E       0       0      36       0       0       0      37
## group_F       0       0      36       0       0       0       0
## group_G       0       0       0       0      39       0      39</code></pre>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="sankey-diagram.html#cb16-1" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Transform it to connection data frame with tidyr from the tidyverse:</span></span>
<span id="cb16-2"><a href="sankey-diagram.html#cb16-2" aria-hidden="true" tabindex="-1"></a>   links <span class="ot">&lt;-</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="sankey-diagram.html#cb16-3" aria-hidden="true" tabindex="-1"></a>     <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-4"><a href="sankey-diagram.html#cb16-4" aria-hidden="true" tabindex="-1"></a>     <span class="fu">rownames_to_column</span>(<span class="at">var=</span><span class="st">&quot;source&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-5"><a href="sankey-diagram.html#cb16-5" aria-hidden="true" tabindex="-1"></a>     <span class="fu">gather</span>(<span class="at">key=</span><span class="st">&quot;target&quot;</span>, <span class="at">value=</span><span class="st">&quot;value&quot;</span>, <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-6"><a href="sankey-diagram.html#cb16-6" aria-hidden="true" tabindex="-1"></a>     <span class="fu">filter</span>(value <span class="sc">!=</span> <span class="dv">0</span>)</span>
<span id="cb16-7"><a href="sankey-diagram.html#cb16-7" aria-hidden="true" tabindex="-1"></a>links</span></code></pre></div>
<pre><code>##     source  target value
## 1  group_B group_A    38
## 2  group_B group_C    36
## 3  group_C group_C    40
## 4  group_E group_C    36
## 5  group_F group_C    36
## 6  group_A group_E    37
## 7  group_G group_E    39
## 8  group_C group_F    38
## 9  group_E group_G    37
## 10 group_G group_G    39</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="sankey-diagram.html#cb18-1" aria-hidden="true" tabindex="-1"></a>   <span class="co"># From these flows we need to create a node data frame: it lists every entities involved in the flow</span></span>
<span id="cb18-2"><a href="sankey-diagram.html#cb18-2" aria-hidden="true" tabindex="-1"></a>   nodes <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb18-3"><a href="sankey-diagram.html#cb18-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">name=</span><span class="fu">c</span>(<span class="fu">as.character</span>(links<span class="sc">$</span>source), <span class="fu">as.character</span>(links<span class="sc">$</span>target)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-4"><a href="sankey-diagram.html#cb18-4" aria-hidden="true" tabindex="-1"></a>       <span class="fu">unique</span>()</span>
<span id="cb18-5"><a href="sankey-diagram.html#cb18-5" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb18-6"><a href="sankey-diagram.html#cb18-6" aria-hidden="true" tabindex="-1"></a>nodes</span></code></pre></div>
<pre><code>##      name
## 1 group_B
## 2 group_C
## 3 group_E
## 4 group_F
## 5 group_A
## 6 group_G</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="sankey-diagram.html#cb20-1" aria-hidden="true" tabindex="-1"></a>   <span class="co"># With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.</span></span>
<span id="cb20-2"><a href="sankey-diagram.html#cb20-2" aria-hidden="true" tabindex="-1"></a>   links<span class="sc">$</span>IDsource <span class="ot">&lt;-</span> <span class="fu">match</span>(links<span class="sc">$</span>source, nodes<span class="sc">$</span>name)<span class="sc">-</span><span class="dv">1</span> </span>
<span id="cb20-3"><a href="sankey-diagram.html#cb20-3" aria-hidden="true" tabindex="-1"></a>   links<span class="sc">$</span>IDtarget <span class="ot">&lt;-</span> <span class="fu">match</span>(links<span class="sc">$</span>target, nodes<span class="sc">$</span>name)<span class="sc">-</span><span class="dv">1</span></span>
<span id="cb20-4"><a href="sankey-diagram.html#cb20-4" aria-hidden="true" tabindex="-1"></a>   links</span></code></pre></div>
<pre><code>##     source  target value IDsource IDtarget
## 1  group_B group_A    38        0        4
## 2  group_B group_C    36        0        1
## 3  group_C group_C    40        1        1
## 4  group_E group_C    36        2        1
## 5  group_F group_C    36        3        1
## 6  group_A group_E    37        4        2
## 7  group_G group_E    39        5        2
## 8  group_C group_F    38        1        3
## 9  group_E group_G    37        2        5
## 10 group_G group_G    39        5        5</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="sankey-diagram.html#cb22-1" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Make the Network</span></span>
<span id="cb22-2"><a href="sankey-diagram.html#cb22-2" aria-hidden="true" tabindex="-1"></a>   p <span class="ot">&lt;-</span> <span class="fu">sankeyNetwork</span>(<span class="at">Links =</span> links, <span class="at">Nodes =</span> nodes,</span>
<span id="cb22-3"><a href="sankey-diagram.html#cb22-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Source =</span> <span class="st">&quot;IDsource&quot;</span>, <span class="at">Target =</span> <span class="st">&quot;IDtarget&quot;</span>,</span>
<span id="cb22-4"><a href="sankey-diagram.html#cb22-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">Value =</span> <span class="st">&quot;value&quot;</span>, <span class="at">NodeID =</span> <span class="st">&quot;name&quot;</span>, </span>
<span id="cb22-5"><a href="sankey-diagram.html#cb22-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sinksRight=</span><span class="cn">FALSE</span>)</span>
<span id="cb22-6"><a href="sankey-diagram.html#cb22-6" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb22-7"><a href="sankey-diagram.html#cb22-7" aria-hidden="true" tabindex="-1"></a>   p</span></code></pre></div>
<div id="htmlwidget-2b90f77be0ac2c2ac68a" style="width:672px;height:480px;" class="sankeyNetwork html-widget"></div>
<script type="application/json" data-for="htmlwidget-2b90f77be0ac2c2ac68a">{"x":{"links":{"source":[0,0,1,2,3,4,5,1,2,5],"target":[4,1,1,1,1,2,2,3,5,5],"value":[38,36,40,36,36,37,39,38,37,39]},"nodes":{"name":["group_B","group_C","group_E","group_F","group_A","group_G"],"group":["group_B","group_C","group_E","group_F","group_A","group_G"]},"options":{"NodeID":"name","NodeGroup":"name","LinkGroup":null,"colourScale":"d3.scaleOrdinal(d3.schemeCategory20);","fontSize":7,"fontFamily":null,"nodeWidth":15,"nodePadding":10,"units":"","margin":{"top":null,"right":null,"bottom":null,"left":null},"iterations":32,"sinksRight":false}},"evals":[],"jsHooks":[]}</script>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="sankey-diagram.html#cb23-1" aria-hidden="true" tabindex="-1"></a>   <span class="co"># save the widget</span></span>
<span id="cb23-2"><a href="sankey-diagram.html#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(htmlwidgets)</span>
<span id="cb23-3"><a href="sankey-diagram.html#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveWidget</span>(p, <span class="at">file=</span><span class="fu">paste0</span>( <span class="fu">getwd</span>(), <span class="st">&quot;/HtmlWidget/sankeyBasic2.html&quot;</span>))</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="boxplot.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["graph.pdf", "graph.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
